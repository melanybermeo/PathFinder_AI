{% extends '../core/components/base.html' %}
{% load static %}

{% block content %}
  <style>
      :root {
          --bg-gradient-start: #3b206b;
          --bg-gradient-end: #5d33a3;
          --text-color: #ffffff;
          --btn-read-bg: #9acd32;
          --btn-pause-bg: #808080;
          --btn-repeat-bg: #87ceeb;
          --btn-back-bg: #c94c4c;
          --focus-outline: #f0e68c;
          --status-bg: rgba(0, 0, 0, 0.5);
      }

      .reader-container {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          flex-grow: 1;
          padding: 20px;
          box-sizing: border-box;
          width: 100%;
          max-width: 900px;
          margin: 0 auto;
          text-align: center;
          margin-top: -30px;
      }

      .reader-title {
          font-size: 2rem;
          font-weight: bold;
          text-transform: uppercase;
          margin-bottom: 5px;
      }

      .reader-subtitle {
          font-size: 1.2rem;
          margin-bottom: 20px;
          opacity: 0.9;
      }

      .camera-container {
          position: relative;
          width: 100%;
          max-width: 640px;
          background-color: #000;
          border: 8px solid #666;
          border-radius: 20px;
          overflow: hidden;
          margin-bottom: 20px;
          min-height: 360px;
          display: flex;
          justify-content: center;
          align-items: center;
      }

      #video-feed {
          width: 100%;
          height: auto;
          display: block;
      }

      .loader {
          position: absolute;
          border: 8px solid #f3f3f3;
          border-top: 8px solid var(--btn-read-bg);
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite;
          display: none;
      }

      @keyframes spin {
          0% {
              transform: rotate(0deg);
          }
          100% {
              transform: rotate(360deg);
          }
      }

      .status-bar {
          background-color: var(--status-bg);
          padding: 10px 20px;
          border-radius: 25px;
          margin-bottom: 20px;
          width: 100%;
          max-width: 640px;
      }

      #status-text {
          color: var(--focus-outline);
          font-weight: bold;
          margin-bottom: 5px;
      }

      #detected-text {
          font-size: 1.1rem;
          min-height: 20px;
      }

      .controls {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 15px;
          width: 100%;
      }

      .btn-reader {
          border: none;
          padding: 15px 25px;
          font-size: 1rem;
          font-weight: bold;
          border-radius: 10px;
          cursor: pointer;
          transition: transform 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
      }

      .btn-reader:disabled {
          cursor: not-allowed;
          opacity: 0.6;
      }

      .btn-read {
          background-color: var(--btn-read-bg);
          color: #333;
      }

      .btn-pause {
          background-color: var(--btn-pause-bg);
          color: white;
      }

      .btn-repeat {
          background-color: var(--btn-repeat-bg);
          color: #333;
      }

      .btn-back {
          background-color: var(--btn-back-bg);
          color: white;
          text-decoration: none;
          border-radius: 25px;
      }
  </style>

  <div class="reader-container">
    <h1 class="reader-title">Lectura de Textos</h1>
    <p class="reader-subtitle">Apunta la c√°mara y presiona "Capturar texto"</p>
    <div class="camera-container">
      <video id="video-feed" playsinline muted autoplay></video>
      <div class="loader" id="loader"></div>
    </div>
    <div class="status-bar">
      <p id="status-text">C√°mara inactiva</p>
      <p id="detected-text">Texto detectado: ...</p>
    </div>
    <div class="controls">
      <button class="btn-reader btn-read" id="main-button">‚ñ∑ Activar c√°mara</button>
      <button class="btn-reader btn-pause" id="btn-pause" disabled>‚ùö‚ùö Pausar</button>
      <button class="btn-reader btn-repeat" id="btn-repeat" disabled>üîÅ Repetir</button>
      <a href="{% url 'auth_api:core:home' %}" class="btn-reader btn-back" id="btn-back">üè† Volver al men√∫ principal</a>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('video-feed');
    const statusText = document.getElementById('status-text');
    const detectedText = document.getElementById('detected-text');
    const mainButton = document.getElementById('main-button');
    const btnPause = document.getElementById('btn-pause');
    const btnRepeat = document.getElementById('btn-repeat');
    const loader = document.getElementById('loader');

    const synthesis = window.speechSynthesis;
    let isCameraOn = false;
    let isProcessing = false;
    let stream;
    let lastApiResultText = "";
    let speechChunks = [];
    let currentChunkIndex = 0;
    let isPausedManually = false;
    let isSpeaking = false;

    // --- UTILS ---
    function splitIntoChunks(text) {
      const words = text.trim().split(/\s+/);
      const chunks = [];
      for (let i = 0; i < words.length; i += 3) {
        chunks.push(words.slice(i, i + 3).join(' '));
      }
      return chunks;
    }

    function updateRepeatButton() {
      const hasValidText = lastApiResultText && 
                          lastApiResultText.trim() !== "" && 
                          lastApiResultText !== "No se detect√≥ texto o contenido.";
      btnRepeat.disabled = !hasValidText;
    }

    function speakChunks(chunks, startIndex = 0, includeClosingMessage = false, onEndCallback = () => {}) {
      if (startIndex >= chunks.length) {
        isSpeaking = false;
        btnPause.disabled = true;

        if (includeClosingMessage) {
          const closingMsg = "Si desea volver a escuchar, haga clic en el bot√≥n de repetir. Para una nueva lectura, haga clic en el bot√≥n de capturar texto.";
          if (window.navigator.vibrate) {
            navigator.vibrate([500, 200, 500]);
          }
          const utterance = new SpeechSynthesisUtterance(closingMsg);
          utterance.lang = 'es-ES';
          utterance.rate = 1;
          utterance.onend = () => {
            enableCaptureMode();
            onEndCallback();
          };
          synthesis.speak(utterance);
        } else {
          enableCaptureMode();
          onEndCallback();
        }
        return;
      }

      const utterance = new SpeechSynthesisUtterance(chunks[startIndex]);
      utterance.lang = 'es-ES';
      utterance.rate = 1;

      utterance.onstart = () => {
        isSpeaking = true;
        statusText.textContent = 'Leyendo...';
        btnPause.disabled = false;
        btnPause.textContent = '‚ùö‚ùö Pausar';
      };

      utterance.onend = () => {
        if (!isPausedManually) {
          currentChunkIndex = startIndex + 1;
          speakChunks(chunks, currentChunkIndex, includeClosingMessage, onEndCallback);
        } else {
          isSpeaking = false;
        }
      };

      utterance.onerror = (e) => {
        console.error("Error TTS:", e);
        isSpeaking = false;
        enableCaptureMode();
      };

      synthesis.speak(utterance);
    }

    function startSpeaking(text, includeClosingMessage = false, onEndCallback = () => {}) {
      synthesis.cancel();
      speechChunks = splitIntoChunks(text);
      currentChunkIndex = 0;
      isPausedManually = false;
      isSpeaking = true;
      speakChunks(speechChunks, 0, includeClosingMessage, onEndCallback);
    }

    function pauseSpeaking() {
      if (isSpeaking && !isPausedManually) {
        synthesis.cancel();
        isPausedManually = true;
        isSpeaking = false;
        statusText.textContent = 'Lectura en pausa...';
        btnPause.textContent = '‚ñ∂ Reanudar';
      }
    }

    function resumeSpeaking() {
      if (isPausedManually && currentChunkIndex < speechChunks.length) {
        isPausedManually = false;
        statusText.textContent = 'Reanudando lectura...';
        btnPause.textContent = '‚ùö‚ùö Pausar';
        speakChunks(speechChunks, currentChunkIndex, false);
      }
    }

    function enableCaptureMode() {
      isProcessing = false;
      mainButton.disabled = false;
      mainButton.textContent = 'üì∏ Capturar texto';
      statusText.textContent = 'C√°mara activa. Apunte y presione "Capturar texto".';
      updateRepeatButton(); // ‚úÖ Actualiza el estado del bot√≥n "Repetir"
    }

    // --- C√ÅMARA ---
    async function startCamera() {
      if (isCameraOn) return;

      mainButton.disabled = true;
      statusText.textContent = 'Iniciando c√°mara...';
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        await video.play();
        isCameraOn = true;
        enableCaptureMode();
        startSpeaking("C√°mara activada. Apunte y presione el bot√≥n para capturar el texto.", false);
      } catch (err) {
        console.error("Error al acceder a la c√°mara:", err);
        statusText.textContent = 'Error al acceder a la c√°mara.';
        mainButton.textContent = '‚ñ∑ Reintentar activar c√°mara';
        mainButton.disabled = false;
        startSpeaking("No se pudo acceder a la c√°mara. Por favor, revise los permisos en su navegador.", false);
      }
    }

    function stopCameraAndSpeech() {
      synthesis.cancel();
      if (stream) stream.getTracks().forEach(track => track.stop());
      video.srcObject = null;
      isCameraOn = false;
      isProcessing = false;
      lastApiResultText = "";
      speechChunks = [];
      currentChunkIndex = 0;
      isSpeaking = false;
      isPausedManually = false;
      mainButton.textContent = '‚ñ∑ Activar c√°mara';
      mainButton.disabled = false;
      statusText.textContent = 'C√°mara inactiva';
      btnPause.disabled = true;
      updateRepeatButton(); // ‚úÖ Asegura que "Repetir" se desactive
      loader.style.display = 'none';
    }

    // --- IA ---
    async function captureAndProcessFrame() {
      if (!isCameraOn || isProcessing || video.readyState < 2) {
        console.warn("No se puede capturar: c√°mara no lista o en procesamiento.");
        return;
      }

      isProcessing = true;
      mainButton.disabled = true;
      btnPause.disabled = true;
      btnRepeat.disabled = true;
      loader.style.display = 'block';
      statusText.textContent = 'Analizando imagen con la IA...';
      detectedText.textContent = "Texto detectado: ...";
      synthesis.cancel();

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = canvas.toDataURL('image/jpeg');

      try {
        const response = await fetch(window.location.href, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image_data: imageData }),
        });

        loader.style.display = 'none';

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Error del servidor: ${response.status}`);
        }

        const result = await response.json();
        const newText = result.text || "No se detect√≥ texto o contenido.";
        lastApiResultText = newText;
        detectedText.textContent = `Resultado: "${newText}"`;
        updateRepeatButton(); // ‚úÖ Habilita "Repetir" si hay texto v√°lido

        startSpeaking(newText, true, () => {
          isProcessing = false;
        });

      } catch (error) {
        console.error("Error procesando el frame:", error);
        loader.style.display = 'none';
        statusText.textContent = `Error: ${error.message}`;
        startSpeaking(`Ocurri√≥ un error: ${error.message}`, false, () => {
          isProcessing = false;
          enableCaptureMode();
        });
      }
    }

    // --- EVENTOS ---
    mainButton.addEventListener('click', () => {
      if (isCameraOn) {
        captureAndProcessFrame();
      } else {
        startCamera();
      }
    });

    btnPause.addEventListener('click', () => {
      if (isPausedManually) {
        resumeSpeaking();
      } else {
        pauseSpeaking();
      }
    });

    btnRepeat.addEventListener('click', () => {
      if (lastApiResultText) {
        startSpeaking(lastApiResultText, false);
      }
    });

    window.addEventListener('pagehide', stopCameraAndSpeech);

    // Mensaje inicial
    startSpeaking("Bienvenido al m√≥dulo de lectura. Presione 'Activar c√°mara' para empezar.", false);
  });
</script>

{% endblock %}