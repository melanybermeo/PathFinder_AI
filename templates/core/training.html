{% extends './components/base.html' %}
{% load static %}

{% block content %}
  {{ exercises|json_script:"exercises-data" }}

  <style>
      /* --- TU CSS (SIN CAMBIOS) --- */
      :root {
          --bg-gradient-start: #3b206b;
          --bg-gradient-end: #5d33a3;
          --text-color: #ffffff;
          --btn-start-bg: #9acd32;
          --btn-examples-bg: #87ceeb;
          --btn-practice-bg: #d3d3d3;
          --btn-back-bg: #c94c4c;
          --focus-outline: #f0e68c;
          --feedback-bg: rgba(0, 0, 0, 0.2);
      }

      .training-container {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          flex-grow: 1;
          padding: 20px;
          box-sizing: border-box;
          width: 100%;
          max-width: 800px;
          margin: 0 auto;
          text-align: center;
      }

      .training-title {
          font-size: 2rem;
          font-weight: bold;
          text-transform: uppercase;
          margin-bottom: 10px;
      }

      .training-subtitle {
          font-size: 1.3rem;
          margin-bottom: 30px;
          opacity: 0.9;
      }

      .action-buttons {
          display: flex;
          flex-direction: column;
          gap: 15px;
          width: 100%;
          max-width: 450px;
          margin-bottom: 30px;
      }

      .btn-training {
          border: none;
          padding: 18px;
          font-size: 1.2rem;
          font-weight: bold;
          border-radius: 12px;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          color: #333;
      }

      .btn-training:hover {
          transform: translateY(-3px);
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      .btn-start {
          background-color: var(--btn-start-bg);
      }

      .btn-examples {
          background-color: var(--btn-examples-bg);
      }

      .btn-practice {
          background-color: var(--btn-practice-bg);
      }

      .btn-back {
          background-color: var(--btn-back-bg);
          color: white;
          border-radius: 50px;
          text-decoration: none;
          margin-top: 20px;
      }

      #exercise-section {
          background-color: var(--feedback-bg);
          border-radius: 15px;
          padding: 25px;
          width: 100%;
          max-width: 500px;
          margin-top: 20px;
          display: none;
          text-align: left;
      }

      #exercise-section h3 {
          margin-top: 0;
          font-size: 1.4rem;
          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
          padding-bottom: 10px;
      }

      #instruction-text {
          font-size: 1.2rem;
          font-style: italic;
          margin: 15px 0;
      }

      #feedback-text {
          font-size: 1.1rem;
          font-weight: bold;
          min-height: 25px;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.6);
          justify-content: center;
          align-items: center;
      }

      .modal-content {
          background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
          border: 1px solid rgba(255, 255, 255, 0.2);
          padding: 25px;
          border-radius: 15px;
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
          box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
          padding-bottom: 15px;
          margin-bottom: 20px;
      }

      .modal-title {
          font-size: 1.5rem;
          margin: 0;
      }

      .modal-close {
          background: none;
          border: none;
          font-size: 2rem;
          color: white;
          cursor: pointer;
          line-height: 1;
      }

      #examples-list {
          list-style: none;
          padding: 0;
      }

      #examples-list li {
          background: var(--feedback-bg);
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 10px;
          text-align: left;
      }

      #examples-list strong {
          display: block;
          font-size: 1.1rem;
          color: var(--btn-examples-bg);
          margin-bottom: 5px;
      }

      @media (max-width: 600px) {
          .training-title {
              font-size: 1.6rem;
          }

          .training-subtitle {
              font-size: 1.1rem;
          }

          .btn-training {
              font-size: 1.1rem;
              padding: 20px;
          }

          .modal-title {
              font-size: 1.3rem;
          }

          .training-container {
            margin-top: -35px;
          }
      }
  </style>

  <div class="training-container">
    <h1 class="training-title">Modo de Entrenamiento</h1>
    <p class="training-subtitle">Practica el uso del asistente con ejercicios guiados</p>

    <div class="action-buttons">
      <button class="btn-training btn-start" id="btn-start-exercise">‚ñ∂Ô∏è Iniciar ejercicio</button>
      <button class="btn-training btn-examples" id="btn-view-examples">üìñ Ver ejemplos de uso</button>
      <button class="btn-training btn-practice" id="btn-practice-commands">üé§ Practicar comandos de voz</button>
    </div>

    <div id="exercise-section">
      <h3>üîä Ejercicio actual:</h3>
      <p id="instruction-text">Diga "..."</p>
      <p id="feedback-text"></p>
    </div>

    <!-- üî• CORRECCI√ìN: Se a√±ade un ID al bot√≥n de volver para referenciarlo f√°cilmente -->
    <a href="{% url 'auth_api:core:home' %}" class="btn-training btn-back" id="btn-back-link">üè† Volver al men√∫
      principal</a>
  </div>

  <div id="examples-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üìñ Ejemplos de Comandos</h2>
        <button class="modal-close" id="modal-close-btn">CERRAR</button>
      </div>
      <ul id="examples-list"></ul>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // --- Referencias a elementos del DOM ---
      const exercises = JSON.parse(document.getElementById('exercises-data').textContent);
      const btnStart = document.getElementById('btn-start-exercise');
      const btnExamples = document.getElementById('btn-view-examples');
      const btnPractice = document.getElementById('btn-practice-commands');
      const btnBack = document.getElementById('btn-back-link'); // <-- Referencia al bot√≥n de volver
      const exerciseSection = document.getElementById('exercise-section');
      const instructionText = document.getElementById('instruction-text');
      const feedbackText = document.getElementById('feedback-text');
      const modal = document.getElementById('examples-modal');
      const btnModalClose = document.getElementById('modal-close-btn');
      const examplesList = document.getElementById('examples-list');

      // --- APIs de Voz ---
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const synthesis = window.speechSynthesis;

      if (!SpeechRecognition) {
        // Manejar el caso en que la API no sea compatible
        console.error("API de Reconocimiento de Voz no compatible.");
        const allButtons = document.querySelectorAll('.btn-training');
        allButtons.forEach(btn => btn.disabled = true);
        const subtitle = document.querySelector('.training-subtitle');
        subtitle.textContent = "Lo sentimos, tu navegador no es compatible con el entrenamiento por voz.";
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.continuous = false; // Solo escucha una vez por cada .start()

      // --- Estado de la aplicaci√≥n ---
      let isPracticeModeActive = false;
      let currentExerciseIndex = 0;

      // --- Funciones de control de voz ---

      /**
       * Detiene inmediatamente cualquier s√≠ntesis de voz y reconocimiento en curso.
       * Esta es la funci√≥n clave para limpiar el estado.
       */
      function stopAllVoiceActivity() {
        synthesis.cancel(); // Detiene la voz que est√° hablando
        recognition.stop(); // Detiene el micr√≥fono que est√° escuchando
      }

      /**
       * Lee un texto en voz alta.
       * @param {string} text - El texto a leer.
       * @param {function} [onEndCallback] - Funci√≥n a ejecutar cuando termine de hablar.
       */
      function speak(text, onEndCallback = () => {
      }) {
        stopAllVoiceActivity(); // Asegura un estado limpio antes de hablar
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES';
        utterance.onend = onEndCallback;
        utterance.onerror = (event) => {
          console.error("Error en la s√≠ntesis de voz:", event);
          onEndCallback(); // Asegura que el flujo contin√∫e incluso si hay un error
        };
        synthesis.speak(utterance);
      }

      /**
       * Inicia un ejercicio espec√≠fico o finaliza el entrenamiento.
       * @param {number} index - El √≠ndice del ejercicio a iniciar.
       */
      function startExercise(index) {
        if (index >= exercises.length) {
          exerciseSection.style.display = 'none';
          isPracticeModeActive = false;
          speak("Felicidades, ha completado todos los ejercicios de entrenamiento.");
          return;
        }
        const exercise = exercises[index];
        instructionText.textContent = `Diga "${exercise.command_text}"`;
        feedbackText.textContent = "";
        speak(`Ejercicio ${index + 1}. Diga: ${exercise.command_text}`, () => {
          // Solo empieza a escuchar si todav√≠a estamos en modo pr√°ctica
          if (isPracticeModeActive) recognition.start();
        });
      }

      // --- Funciones de la Interfaz (Modal) ---

      function openExamplesModal() {
        examplesList.innerHTML = '';
        if (exercises.length === 0) {
          examplesList.innerHTML = '<li>No hay ejemplos para mostrar.</li>';
        } else {
          exercises.forEach(ex => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<strong>${ex.command_text}</strong><p>${ex.explanation_text || 'Acci√≥n de pr√°ctica.'}</p>`;
            examplesList.appendChild(listItem);
          });
        }
        modal.style.display = 'flex';
      }

      function closeExamplesModal() {
        modal.style.display = 'none';
        stopAllVoiceActivity(); // Detiene la voz al cerrar el modal
      }

      // --- L√≥gica de Event Listeners ---

      btnStart.addEventListener('click', () => {
        isPracticeModeActive = true;
        currentExerciseIndex = 0;
        exerciseSection.style.display = 'block';
        speak("Iniciando modo de entrenamiento.", () => startExercise(currentExerciseIndex));
      });

      btnExamples.addEventListener('click', () => {
        isPracticeModeActive = false;
        exerciseSection.style.display = 'none';

        openExamplesModal();

        if (exercises.length === 0) {
          speak("No hay ejemplos para mostrar.");
          return;
        }

        let fullExplanation = "Escuche atentamente los siguientes ejemplos de uso. ";
        exercises.forEach(ex => {
          fullExplanation += `El comando: ${ex.command_text}. Sirve para: ${ex.explanation_text || 'esta acci√≥n'}. `;
        });
        speak(fullExplanation);
      });

      // El bot√≥n de pr√°ctica simplemente simula un clic en el de iniciar.
      btnPractice.addEventListener('click', () => btnStart.click());

      // Listeners para cerrar el modal
      btnModalClose.addEventListener('click', closeExamplesModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) closeExamplesModal();
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.style.display === 'flex') closeExamplesModal();
      });

      // --- üî• CORRECCI√ìN CLAVE: Detener todo al salir de la p√°gina ---
      // El evento 'pagehide' es la forma m√°s fiable de limpiar antes de que el usuario abandone la p√°gina.
      window.addEventListener('pagehide', stopAllVoiceActivity);

      // Tambi√©n detenemos la voz inmediatamente al hacer clic en el enlace de "Volver".
      btnBack.addEventListener('click', stopAllVoiceActivity);

      // --- Manejo de Resultados y Errores del Reconocimiento de Voz ---
      recognition.onresult = (event) => {
        if (!isPracticeModeActive) return; // Ignorar si no estamos en modo pr√°ctica

        const transcript = event.results[0][0].transcript.trim().toLowerCase();
        const expectedCommand = exercises[currentExerciseIndex].command_text.trim().toLowerCase();
        const cleanTranscript = transcript.replace(/[.,¬°!¬ø?]/g, '');
        const cleanExpected = expectedCommand.replace(/[.,¬°!¬ø?]/g, '');

        if (cleanTranscript === cleanExpected) {
          feedbackText.textContent = "‚úÖ Correcto, contin√∫e al siguiente.";
          speak("Correcto. Siguiente ejercicio.", () => {
            currentExerciseIndex++;
            setTimeout(() => startExercise(currentExerciseIndex), 500); // Peque√±a pausa
          });
        } else {
          feedbackText.textContent = `‚ùå Se esperaba "${expectedCommand}". Se escuch√≥ "${transcript}". Intente de nuevo.`;
          speak("Comando incorrecto. Por favor, intente de nuevo.", () => {
            if (isPracticeModeActive) recognition.start();
          });
        }
      };

      recognition.onerror = (event) => {
        if (isPracticeModeActive) {
          if (event.error === 'no-speech' || event.error === 'audio-capture') {
            speak("No pude escuchar. Por favor, hable m√°s claro e int√©ntelo de nuevo.", () => {
              if (isPracticeModeActive) recognition.start();
            });
          } else if (event.error === 'not-allowed') {
            speak("El acceso al micr√≥fono fue denegado. Por favor, revise los permisos.");
            isPracticeModeActive = false; // Salir del modo pr√°ctica
          }
        }
      };

      // --- Mensaje de bienvenida inicial ---
      speak("Bienvenido al modo de entrenamiento. Puede iniciar un ejercicio, ver ejemplos, practicar comandos de voz o volver al men√∫ principal.");
    });
  </script>

{% endblock %}